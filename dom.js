let globalDataCache=null;const goalMapping={"Lead Form":["LEAD_GENERATION","QUALITY_LEAD"],Awareness:["REACH","AD_RECALL_LIFT","IMPRESSIONS"],Engagement:["POST_ENGAGEMENT","THRUPLAY","EVENT_RESPONSES"],Message:["REPLIES"],Traffic:["OFFSITE_CONVERSIONS","LINK_CLICKS","PROFILE_VISIT","LADING_PAGE_VIEWS"],Pagelike:["PAGE_LIKES"]},resultMapping={REACH:"reach",LEAD_GENERATION:"lead",QUALITY_LEAD:"lead",THRUPLAY:"video_view",POST_ENGAGEMENT:"post_engagement",PROFILE_VISIT:"link_click",LINK_CLICKS:"link_click",LADING_PAGE_VIEWS:"link_click",REPLIES:"messenger_start",IMPRESSIONS:"impressions",PAGE_LIKES:"follows"},mainClr="#ffa900db";let globalData={},startDate="",endDate="",query="",dataFullAdset=[],dataCampaignNow=[],tableDataGlobal=[],dataAdsetNow=[],allDatasets=[],isViewPerformance=!1,quickID=0,activeCampaignID=0,campaignNOW="",adsetNOW="",date_preset="",chartSpentType=null,dailyChartInstance=null,hourlyChartInstance=null,businessID="1455833788582384";const actionTypes={follows:"like",lead:"onsite_conversion.lead_grouped",reactions:"post_reaction",comments:"comment",share:"post",link_click:"link_click",messenger_start:"onsite_conversion.messaging_conversation_started_7d",post_engagement:"post_engagement",photo_view:"photo_view",video_view:"video_view",post_save:"onsite_conversion.post_save"},menuItems=document.querySelectorAll(".dom_main_menu li"),menu=document.querySelector(".dom_main_menu"),demoTitleCampaign=document.querySelector(".dom_demographic_title_item.campaign"),demoTitleAdset=document.querySelector(".dom_demographic_title_item.adset"),loading=document.querySelector(".loading"),dom_account_view=document.querySelector(".dom_account_view"),fixapp=document.querySelector("#fixapp"),dom_sidebar=document.querySelector("#dom_sidebar"),domPayment=document.querySelector("#dom_payment"),domContent=document.querySelector("#dom_content"),dom_demographic_back=document.querySelector(".dom_demographic_title i"),dom_demographic=document.querySelector(".dom_demographic"),menuQuick=document.querySelector(".dom_sub_menu"),blockSpentChart=document.querySelector(".spent_chart"),dom_filter_head_title=document.querySelector(".dom_filter_head h2"),timeItems=document.querySelectorAll(".dom_select_show.time li"),switchBtns=document.querySelectorAll(".dom_switch_btns p"),selecItemTime=document.querySelector(".dom_selected.time"),selecItemDaily=document.querySelector(".dom_selected.daily"),selecItemDailyText=document.querySelector(".dom_selected.daily .dom_selected_text"),zoomBtn=document.querySelector(".dom_logo > i"),barBtn=document.querySelector(".dom_navbar"),dom_total=document.querySelector(".dom_total"),table=document.getElementById("main_table"),tableBody=document.querySelector("#main_table > tbody"),tableHead=document.querySelector("#main_table > thead"),tableFooter=document.querySelector("#main_table > tfoot"),dom_toplist=document.querySelector(".dom_toplist"),dom_toplist_event=document.querySelector(".dom_toplist.event"),searchInput=document.querySelector(".dom_search"),dom_rpr=document.querySelector(".dom_rpr"),dom_cpm=document.querySelector(".dom_cpm"),dom_userP=document.querySelector(".dom_user p"),dom_userIMG=document.querySelector(".dom_user img"),custom_item=document.querySelector(".custom_item"),dom_time_show=document.querySelector("#dom_time_show"),dom=document.querySelector("#dom"),apply_custom_date=document.querySelector(".apply_custom_date"),selectCampaignList=document.querySelector(".dom_selected.campaign .dom_select_show"),selectAdsetList=document.querySelector(".dom_selected.adset .dom_select_show"),selectCampaign=document.querySelector(".dom_selected.campaign"),selectAdset=document.querySelector(".dom_selected.adset"),frequency_impression=document.querySelector(".dom_frequency_label_impression"),frequency_reach=document.querySelector(".dom_frequency_label_reach"),selecedTextTime=document.querySelector(".dom_selected.time .dom_selected_text"),selecedTextCampaign=document.querySelector(".dom_selected.campaign .dom_selected_text"),selecedTextAdset=document.querySelector(".dom_selected.adset .dom_selected_text"),dom_sidebar_overlay=document.querySelector(".dom_sidebar_overlay");function removeActiveFrom(e){const t=document.querySelector(e);t&&t.classList.remove("active")}fixapp.addEventListener("click",(()=>{localStorage.clear(),location.reload()})),document.title=`DOM Report - Meta - ${accName}`,dom_userP.textContent=accName,dom_userIMG.src=accAvatar,dom_account_view.innerHTML=`\n          <div class="account_item">\n            <img class="account_item_avatar" src="${accAvatar}">\n            <div class="account_item_info">\n              <p class="account_item_name">${accName}</p>\n              <p class="account_item_id">${adAccountId}</p>\n            </div>\n          </div>\n`,barBtn.addEventListener("click",(()=>{dom_sidebar.classList.add("active")})),dom_sidebar.addEventListener("click",(()=>{dom_sidebar.classList.remove("active")})),dom_sidebar_overlay.addEventListener("click",(()=>{dom_sidebar.classList.remove("active")})),zoomBtn.addEventListener("click",(()=>{dom.classList.toggle("zoom"),window.innerWidth<=768&&dom.classList.remove("zoom")})),selectCampaign.addEventListener("click",(()=>{removeActiveFrom(".dom_selected.adset.active"),selectCampaign.classList.toggle("active")})),dom_demographic_back.addEventListener("click",(()=>{dom_demographic.classList.remove("active")})),tableBody.addEventListener("click",(e=>{const t=e.target.closest(".view_insights");if(!t)return;handleViewDemographic(t.dataset.campaign||"Unknown",t.dataset.adset||"Unknown")})),selectAdset.addEventListener("click",(()=>{removeActiveFrom(".dom_selected.campaign.active"),selectAdset.classList.toggle("active")}));const debouncedFilter=useDebounce((e=>{filterTableByCampaign(e.target.value)}),500);function showPerformanceTab(){domContent.classList.remove("none"),domPayment.classList.add("none")}function showPaymentTab(){domContent.classList.add("none"),domPayment.classList.remove("none")}async function fetchData(e,t){let a=[],n=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?level=adset&fields=campaign_name,adset_name,adset_id,spend,impressions,reach,actions,optimization_goal&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&time_range={"since":"${e}","until":"${t}"}&access_token=${accessToken}&limit=1000`;try{for(;n;){const e=await fetch(n);if(!e.ok)throw new Error(`Network error: ${e.statusText}`);const t=await e.json();if(t.error)return;a=[...a,...t.data||[]],n=t.paging&&t.paging.next?t.paging.next:null}return a}catch(e){}}async function fetchDataDaily(e,t){let a=[],n=`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?fields=spend,reach,actions,date_start&time_increment=1&time_range={"since":"${e}","until":"${t}"}&access_token=${accessToken}&limit=1000`;try{for(;n;){const e=await fetch(n);if(!e.ok)throw new Error(`Network error: ${e.statusText}`);const t=await e.json();if(t.error)return void document.querySelector(".loading").classList.remove("active");a=[...a,...t.data||[]],n=t.paging&&t.paging.next?t.paging.next:null}return a}catch(e){}}function handleViewPerformance(){showPerformanceTab();const e=document.querySelectorAll(".dom_sub_menu li");dom.classList.add("isViewPerformance"),isViewPerformance=!0,localStorage.viewPerformance="1",e[quickID].click()}function renderQuickFilter(){menuQuick.innerHTML=quickFilter.map(((e,t)=>`\n      <li data-filter="${e}" data-index="${t}">\n        <i class="fa-solid fa-bolt"></i>\n        <span>${e}</span>\n      </li>\n    `)).join(""),menuQuick.addEventListener("click",(e=>{showPerformanceTab();const t=e.target.closest("li");if(!t)return;quickID=Number(t.dataset.index),setActiveOnly(t,".dom_sub_menu li.active"),activeCampaignID=0,dom_filter_head_title.textContent=`Report for ${quickFilter[quickID]}`,selecedTextCampaign.textContent="Data for all campaigns",campaignNOW="",adsetNOW="";const a=quickFilterData(quickFilter[quickID]);renderCampaignRadioBox(a),viewFilter(a),selectAdset.classList.remove("show"),localStorage.quickID=quickID,blockSpentChart.classList.remove("none")}))}function viewFilter(e){if(!menuItems[1].classList.contains("active")){const e=document.querySelector(".dom_main_menu li.active");e&&e.classList.remove("active"),menuItems[1].classList.add("active")}useData(e),campaignNOW?switchBtns[1].click():switchBtns[0].click()}function quickFilterData(e,t,a){if(!(isBrand||e&&goalMapping[e]))throw new Error("Invalid or missing goal");return dataFullAdset.filter((n=>(isBrand?n.campaign_name.toLowerCase().includes(e.toLowerCase()):goalMapping[e].includes(n.optimization_goal))&&(!t||n.campaign_name===t)&&(!a||n.adset_name===a)))}function processData(e,t){const a=Object.create(null),n=Object.create(null),o=Object.create(null),s=new Set(quickFilter),r=Object.entries(goalMapping),i=new Array(e.length);for(let e=0;e<r.length;e++)n[r[e][0]]=0;const c=document.createDocumentFragment(),l=e.length;for(let d=0;d<l;d++){const l=e[d],m=l.campaign_name||"Unknown",u=Number(l.spend)||0,p=l.optimization_goal||"Unknown";if(a[m]=(a[m]||0)+u,isBrand&&t){for(const e of s)if(m.includes(e)){o[e]=(o[e]||0)+u;break}}else for(let e=0;e<r.length;e++){const[t,a]=r[e];if(a.includes(p)){n[t]+=u;break}}const g={id:d,campaign_name:m,adset_name:l.adset_name||"N/A",insights:'<i class="fa-solid fa-magnifying-glass-chart"></i>',optimization_goal:p,spend:u,reach:l.reach||0,impressions:l.impressions||0,frequency:l.reach>0?(l.impressions/l.reach).toFixed(2):"0",cpm:l.impressions>0?(1e3*u/l.impressions).toFixed(0):"0"};for(const e in actionTypes)g[e]=l.actions?.find((t=>t.action_type===actionTypes[e]))?.value||0;g.result=resultMapping[p]&&g[resultMapping[p]]||0,g.cpr=(g.spend/(g.result||1)).toFixed(g.spend/(g.result||1)>50?0:1),i[d]=g;const h=document.createElement("tr");h.dataset.id=g.id,h.innerHTML=`\n      <td><input type="checkbox" class="dom_select_row" data-id="${g.id}"></td>\n      <td>${g.campaign_name}</td>\n      <td>${g.adset_name}</td>\n      <td class="view_insights" data-campaign="${g.campaign_name}" \n          data-adset="${g.adset_name}">\n        ${g.insights}\n      </td>\n      <td>${formatCurrency(g.spend)}</td>\n      <td>${g.reach}</td>\n      <td>${g.impressions}</td>\n      <td>${g.result}</td>\n      <td>${formatCurrency(g.cpr)}</td>\n      <td>${formatMetricName(g.optimization_goal)}</td>\n      <td>${g.frequency}</td>\n      <td>${g.follows}</td>\n      <td>${g.reactions}</td>\n      <td>${g.messenger_start}</td>\n      <td>${g.lead}</td>\n      <td>${formatCurrency(g.cpm)}</td>\n      <td>${g.post_engagement}</td>\n      <td>${g.video_view}</td>\n      <td>${g.photo_view}</td>\n      <td>${g.comments}</td>\n      <td>${g.post_save}</td>\n      <td>${g.share}</td>\n      <td>${g.link_click}</td>\n    `,c.appendChild(h)}return{dataFilter:e,campaignTotal:a,optimizationTotal:n,brandTotal:o,tableData:i,tbodyHTML:c}}function renderTopCampaign(e){if(!e||"object"!=typeof e||!dom_toplist)return;if("function"!=typeof formatCurrency)return;const t=[];let a=0;for(const[n,o]of Object.entries(e)){const e=parseFloat(o)||0;e>0&&(t.push([n,e]),e>a&&(a=e))}if(!t.length)return void dom_toplist.replaceChildren();t.sort(((e,t)=>t[1]-e[1]));const n=document.createDocumentFragment();for(let e=0,o=t.length;e<o;e++){const[o,s]=t[e],r=document.createElement("li"),i=document.createElement("p");i.innerHTML=`<span>${o}</span><span>${formatCurrency(s)}</span>`;const c=document.createElement("p"),l=document.createElement("span");l.classList.add("progress-bar"),l.style.width=`${(s/a*100).toFixed(2)}%`,c.appendChild(l),r.appendChild(i),r.appendChild(c),n.appendChild(r)}dom_toplist.replaceChildren(n)}function getUniqueCampaignNames(e){return Array.isArray(e)?[...new Set(e.reduce(((e,t)=>(t.campaign_name&&e.push(t.campaign_name),e)),[]))]:[]}function renderCampaignRadioBox(e){if(!e||"object"!=typeof e||!selectCampaignList)return;selectCampaignList.innerHTML="";const t=getUniqueCampaignNames(e),a=document.createDocumentFragment(),n=(e,t,a=!1)=>{const n=document.createElement("li");return n.classList.add("campaign-item"),a&&n.classList.add("active"),n.dataset.index=t,e&&(n.dataset.name=e),n.innerHTML=`\n      <span class="radio_box"></span>\n      <span>${e||"Data for all campaigns"}</span>\n    `,n};a.appendChild(n(null,0,!0)),t.forEach(((e,t)=>{a.appendChild(n(e,t+1))})),selectCampaignList.appendChild(a)}function renderAdsetinCampaign(e){if(selectAdsetList.innerHTML="",!e?.length)return;const t=document.createDocumentFragment(),a=(e,t,a=!1)=>{const n=document.createElement("li");return n.classList.add("adset-item"),a&&n.classList.add("active"),n.dataset.index=t,e&&(n.dataset.name=e),n.innerHTML=`\n      <span class="radio_box"></span>\n      <span>${e||"Data for all adsets"}</span>\n    `,n};t.appendChild(a(null,0,!0)),e.forEach(((e,n)=>{t.appendChild(a(e.adset_name,n+1))})),selectAdsetList.appendChild(t)}function renderTopEvent(e){if(!e||"object"!=typeof e)return;dom_toplist_event.innerHTML="",e.result&&(dom_rpr.textContent=formatNumber((e.reach/e.result).toFixed(0))),e.impressions&&(dom_cpm.textContent=formatCurrency((1e3*e.spent/e.impressions).toFixed(0)),renderFrequency(e.impressions,e.reach));const t=Object.entries(e).filter((([e])=>!["spent","impressions","reach","result"].includes(e))).map((([e,t])=>({name:e,value:t||0}))).sort(((e,t)=>t.value-e.value));if(0===t.length)return;const a=t[0].value,n=document.createDocumentFragment();t.forEach((({name:e,value:t})=>{const o=document.createElement("li"),s=document.createElement("p"),r=document.createElement("span");r.textContent=formatMetricName(e);const i=document.createElement("span");i.textContent=formatNumber(t),s.appendChild(r),s.appendChild(i);const c=document.createElement("p"),l=document.createElement("span");l.style.width=`${(t/a*100).toFixed(2)}%`,c.appendChild(l),o.appendChild(s),o.appendChild(c),n.appendChild(o)})),dom_toplist_event.appendChild(n)}function renderFrequency(e,t){const a=t>0?(e/t).toFixed(2):"0";document.querySelector(".frequency_number").textContent=a,document.querySelector(".semi-donut").style.setProperty("--percentage",Math.min(a/4*100,100)),frequency_impression.textContent=formatNumber(e),frequency_reach.textContent=formatNumber(t)}function renderTopAdset(e){if(!Array.isArray(e)||0===e.length)return void dom_toplist.replaceChildren();let t=0;const a=[];for(let n=0,o=e.length;n<o;n++){const o=parseFloat(e[n].spend)||0;o>0&&(a.push({name:e[n].adset_name||"Unknown",value:o}),o>t&&(t=o))}a.sort(((e,t)=>t.value-e.value));const n=document.createDocumentFragment();for(let e=0,o=a.length;e<o;e++){const{name:o,value:s}=a[e],r=document.createElement("li"),i=document.createElement("p");i.innerHTML=`<span>${o}</span><span>${formatCurrency(s)}</span>`;const c=document.createElement("p"),l=document.createElement("span");l.classList.add("progress-bar"),l.style.width=`${(s/t*100).toFixed(2)}%`,c.appendChild(l),r.appendChild(i),r.appendChild(c),n.appendChild(r)}dom_toplist.replaceChildren(n)}function renderTableHead(){tableHead&&(tableHead.innerHTML=`<tr>${['<input type="checkbox" id="dom_select_all">',"Campaign Name","Adset Name","Insights","Cost Spent","Reach","Impression","Result","CPR","Optimization Goal","Frequency","Follows","Reaction","Messenger Start","Lead","CPM","Engagement","Video view","Photo view","Comments","Post Save","Share","Link Click"].map((e=>`<th>${e}</th>`)).join("")}</tr>`)}function updateFooterOnCheck(e){if(!tableFooter)return;const t=document.querySelectorAll(".dom_select_row:checked"),a=document.querySelectorAll(".dom_select_row"),n=0===t.length,o=n?a:t,s=new Map(e.map((e=>[e.id,e]))),r=["spend","reach","impressions","result","-","-","-","follows","reactions","messenger_start","lead","-","post_engagement","video_view","photo_view","comments","post_save","share","link_click"],i=new Float64Array(r.length);for(let e=0,t=o.length;e<t;e++){const t=0|o[e].dataset.id,a=s.get(t);if(a)for(let e=0;e<r.length;e++)"-"!==r[e]&&(i[e]+=+a[r[e]]||0)}let c=`<tr><td colspan="4"><strong>${n?`Total ${a.length} Row`:`Total x${t.length} Selected Row`}</strong></td>`;for(let e=0;e<r.length;e++)c+=`<td>${"-"===r[e]?"-":"spend"===r[e]?formatCurrency(i[e]):formatNumber(i[e])}</td>`;tableFooter.innerHTML=c;const l={spent:i[0],reach:i[1],impressions:i[2],post_engagement:i[12],lead:i[10],message:i[9],link_click:i[19],reactions:i[8],likepage:i[7],post_save:i[15],video_view:i[13],photo_view:i[14],comments:i[16],share:i[17],result:i[3]};renderMetricTotal(l,calculateMetricByGoal(Array.from(o,(e=>s.get(0|e.dataset.id))))),isViewPerformance&&renderTopEvent(l)}function calculateMetricByGoal(e){const t=Object.create(null);for(let a=0,n=e.length;a<n;a++){const n=e[a],o=n.optimization_goal||"Unknown";t[o]||(t[o]={spent:0,reach:0,impressions:0,post_engagement:0,lead:0,message:0,link_click:0,reactions:0,likepage:0});const s=t[o];s.spent+=+n.spend||0,s.reach+=+n.reach||0,s.impressions+=+n.impressions||0,s.post_engagement+=+n.post_engagement||0,s.lead+=+n.lead||0,s.message+=+n.messenger_start||0,s.link_click+=+n.link_click||0,s.reactions+=+n.reactions||0,s.likepage+=+n.follows||0}return t}function calculateUnit(e,t,a,n=1){let o=0,s=0;for(let n=0,r=e.length;n<r;n++){const r=t[e[n]];r&&(o+=r.spent||0,s+=r[a]||0)}return s>0?o/s*n|0:"-"}function filterTableByCampaign(e){const t=e.toLowerCase().trim();useData(dataFullAdset.filter((e=>e.campaign_name.toLowerCase().includes(t)||e.adset_name.toLowerCase().includes(t))))}function renderMetricTotal(e,t){let a=[{name:"Total Spent",icon:"fa-solid fa-sack-dollar",type:"Total Spent",value:e.spent,unit:"Spent"},{name:"Total Reach",icon:"fa-solid fa-street-view",type:"Cost per 1000 Reach",value:e.reach,unit:calculateUnit(["REACH"],t,"reach",1e3)},{name:"Total Message",icon:"fa-solid fa-photo-film",type:"Cost per Message",value:e.message,unit:calculateUnit(["REPLIES"],t,"message")},{name:"Likepage/Follows",icon:"fa-solid fa-thumbs-up",type:"Cost per LikePage",value:e.likepage,unit:calculateUnit(["PAGE_LIKES"],t,"likepage")},{name:"Engagements",icon:"fa-solid fa-photo-film",type:"Cost per Engagement",value:e.post_engagement,unit:calculateUnit(["POST_ENGAGEMENT"],t,"post_engagement")},{name:"Total Impressions",icon:"fa-solid fa-eye",type:"Awareness CPM",value:e.impressions,unit:calculateUnit(["REACH"],t,"impressions",1e3)},{name:"Total Leads",icon:"fa-solid fa-bullseye",type:"Cost per Lead",value:e.lead,unit:calculateUnit(["QUALITY_LEAD","LEAD_GENERATION"],t,"lead")},{name:"Total Reactions",icon:"fa-solid fa-heart",type:"Cost per Reaction",value:e.reactions,unit:calculateUnit(["POST_ENGAGEMENT"],t,"reactions")}],n=document.createDocumentFragment(),o=document.createElement("div"),s="";for(let e=0,t=a.length;e<t;e++){let{name:t,icon:n,type:o,value:r,unit:i}=a[e];s+=`\n      <div class="dom_total_item">\n        <div>\n          <p class="dom_total_type">${t}</p>\n          <p class="dom_total_number">${formatNumber(r)}</p>\n        </div>\n        <div class="dom_total_unit">\n          ${"Spent"===i?'<a class="dom_unit_number">Excludes +5% VAT</a>':`<p class="dom_unit_number">${"-"!==i?formatCurrency(i):i}</p>`}\n          <p class="dom_unit_text">${o}</p>\n        </div>\n        <i class="${n}"></i>\n      </div>`}for(o.innerHTML=s;o.firstChild;)n.appendChild(o.firstChild);dom_total.replaceChildren(n)}function formatCurrency(e){return"-"===e?"-":new Intl.NumberFormat("vi-VN").format(e)+" ₫"}function formatNumber(e){return"-"===e?"-":new Intl.NumberFormat("de-DE").format(e)}function formatCurrencyText(e){return e>=1e9?(e/1e9).toFixed(1)+"B":e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toLocaleString("vi-VN")+" đ"}function formatMetricName(e){return e.toLowerCase().replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}function getFormattedDateRange(e){const t=new Date;let a,n;switch(e){case"today":a=n=t;break;case"yesterday":a=new Date(t),a.setDate(t.getDate()-1),n=a;break;case"this%5fmonth":a=new Date(Date.UTC(t.getFullYear(),t.getMonth(),1,7)),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),7));break;case"last%5fmonth":a=new Date(Date.UTC(t.getFullYear(),t.getMonth()-1,1,7)),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),0,7));break;case"this%5fquarter":a=new Date(Date.UTC(t.getFullYear(),3*Math.floor(t.getMonth()/3),1,7)),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),7));break;case"last%5fquarter":n=new Date(Date.UTC(t.getFullYear(),3*Math.floor(t.getMonth()/3),0,7)),a=new Date(Date.UTC(t.getFullYear(),3*Math.floor(t.getMonth()/3)-3,1,7));break;case"this_year":a=new Date(Date.UTC(t.getFullYear(),0,1,7)),n=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),7));break;case"custom_date":a=new Date(startDate),n=new Date(endDate);break;default:return""}if(startDate=formatApiDate(a),endDate=formatApiDate(n),"custom_date"===e){const e=`?start=${formatDateForQuery(startDate)}&end=${formatDateForQuery(endDate)}`;history.pushState(null,"",e)}else history.pushState(null,"",window.location.pathname);return a.getTime()===n.getTime()?formatDate(a):`${formatDate(a)} - ${formatDate(n)}`}function formatDateForQuery(e){if(!e||"string"!=typeof e)return"";const[t,a,n]=e.split("-");return`${n}-${a}-${t}`}function formatDate(e){const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`}function formatApiDate(e){return e.toISOString().split("T")[0]}function drawBarChart(e){chartSpentType&&chartSpentType.destroy();const t=Object.keys(e),a=Object.values(e),n=document.getElementById("chartSpentType").getContext("2d");chartSpentType=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Spent",data:a,backgroundColor:mainClr}]},options:{responsive:!0,borderRadius:5,plugins:{legend:{display:!1},tooltip:{enabled:!0},datalabels:{anchor:"end",align:"top",color:"#7c7c7c",font:{size:11,weight:"bold"},formatter:function(e){return formatCurrency(e)}}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:!0,ticks:{font:{size:9}},afterDataLimits:e=>{e.max*=1.1}}}},plugins:[ChartDataLabels]})}function drawDailyChart(e,t,a,n,o,s,r,i,c){const l=document.getElementById("chartDaily").getContext("2d"),d=l.createLinearGradient(0,0,0,400);d.addColorStop(0,"rgba(255, 171, 0,0.7)"),d.addColorStop(1,"rgba(255, 171, 0, 0.1)"),dailyChartInstance&&dailyChartInstance.destroy(),allDatasets=[{label:"Post Engagement",data:r,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Leads",data:c,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Link Click",data:i,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Spend",data:t,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Reach",data:a,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Message Start",data:n,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Post Reactions",data:o,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1},{label:"Page Likes",data:s,backgroundColor:d,borderColor:"rgba(255, 171, 0, 1)",fill:!0,tension:.1}],dailyChartInstance=new Chart(l,{type:"line",data:{labels:e,datasets:allDatasets.filter((e=>"Spend"===e.label))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",display:!1}},scales:{x:{ticks:{font:{size:12}}},y:{beginAtZero:!0,ticks:{font:{size:12}}}}}})}function updateChart(e){if(dailyChartInstance){const t=[...allDatasets].filter((t=>t.label===e));t.length>0&&(dailyChartInstance.data.datasets=t,dailyChartInstance.update())}}function handleDailyDate(e){let t=[],a=[],n=[],o=[],s=[],r=[],i=[],c=[],l=[];0!==e.length?(e.forEach((e=>{const d=e?.date_start||"Unknown Date",m=parseFloat(e?.spend)||0,u=parseFloat(e?.reach)||0;let p=0,g=0,h=0,_=0,f=0,y=0;e.actions&&Array.isArray(e.actions)&&e.actions.forEach((e=>{"onsite_conversion.messaging_conversation_started_7d"===e?.action_type&&(p=e?.value||0),"post_reaction"===e?.action_type&&(g=e?.value||0),"like"===e?.action_type&&(h=e?.value||0),"post_engagement"===e?.action_type&&(_=e?.value||0),"link_click"===e?.action_type&&(f=e?.value||0),"onsite_conversion.lead_grouped"===e?.action_type&&(y=e?.value||0)})),t.push(d),a.push(m),n.push(u),o.push(p),s.push(g),r.push(h),i.push(_),c.push(f),l.push(y)})),drawDailyChart(t,a,n,o,s,r,i,c,l)):drawDailyChart(t,a,n,o,s,r,i,c,l)}async function fetchHourlyData(e){try{const t=await fetch(e);processHourlyData((await t.json()).data)}catch(e){}}function processHourlyData(e){const t=[],a=[],n=[];e.forEach((e=>{const o=e.hourly_stats_aggregated_by_advertiser_time_zone.split(":")[0];t.push(1*o+"h"),a.push(e.impressions),n.push(e.spend)})),drawHourlyChart(t,a,n),loading.classList.remove("active")}function drawHourlyChart(e,t,a){const n=document.getElementById("hourlyChart").getContext("2d"),o=n.createLinearGradient(0,0,0,400);o.addColorStop(0,"rgba(48, 51, 86, 0.7)"),o.addColorStop(1,"rgba(48, 51, 86, 0.1)");const s=n.createLinearGradient(0,0,0,400);s.addColorStop(0,"rgba(255, 171, 0,0.7)"),s.addColorStop(1,"rgba(255, 171, 0, 0.1)"),window.hourlyChartInstance&&window.hourlyChartInstance.destroy(),window.hourlyChartInstance=new Chart(n,{type:"line",data:{labels:e,datasets:[{label:"Impressions",data:t,backgroundColor:o,borderColor:"rgba(48, 51, 86, 1)",borderWidth:2,tension:.3,fill:!0},{label:"Spend",data:a,backgroundColor:s,borderColor:"rgba(255, 171, 0, 1)",borderWidth:2,tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top",align:"end"}},scales:{x:{title:{display:!1,text:"Giờ trong ngày"},ticks:{min:0,max:23,stepSize:1}},y:{beginAtZero:!0,title:{display:!1,text:"Số lượng"}}}}})}function useDebounce(e,t){let a;return(...n)=>{clearTimeout(a),a=setTimeout((()=>e(...n)),t)}}function setActiveOnly(e,t){if(t){const e=document.querySelector(t);e&&e.classList.remove("active")}e.classList.add("active")}function removeActiveOnly(e){document.querySelector(e)&&document.querySelector(e).classList.remove("active")}function useData(e,t){let a;if(t?globalDataCache?a=globalDataCache:(a=processData(e,!0),globalDataCache=a):a=processData(e),tableBody.innerHTML="",a.tbodyHTML&&a.tbodyHTML.childNodes.length>0){const e=a.tbodyHTML.cloneNode(!0);tableBody.appendChild(e)}tableDataGlobal=a.tableData,updateFooterOnCheck(tableDataGlobal);drawBarChart(isBrand&&t?a.brandTotal:a.optimizationTotal),renderTopCampaign(a.campaignTotal),dataAdsetNow=a.dataFilter,dataCampaignNow=a.campaignTotal}async function mainApp(){globalDataCache=null,selecItemTime.classList.remove("active"),dom_time_show.textContent=getFormattedDateRange(date_preset),loading.classList.add("active");const[e,t]=await Promise.all([fetchData(startDate,endDate),fetchDataDaily(startDate,endDate)]);dataFullAdset=Array.isArray(e)?e:[],handleDailyDate(t),useData(dataFullAdset,!0),renderQuickFilter(),"1"===localStorage.getItem("viewPerformance")&&handleViewPerformance(),loading.classList.remove("active")}function loadScript(e,t){const a=document.createElement("script");a.src=e,a.onload=t,document.head.appendChild(a)}function getStartEndFromURL(){const e=new URLSearchParams(window.location.search);let t=e.get("start"),a=e.get("end");if(t&&a){const[e,n,o]=t.split("-").map(Number),[s,r,i]=a.split("-").map(Number);if(t=new Date(Date.UTC(o,n-1,e)),a=new Date(Date.UTC(i,r-1,s)),!isNaN(t.getTime())&&!isNaN(a.getTime()))return startDate=t,endDate=a,date_preset="custom_date",selecedTextTime.textContent="Custom Date",void setActiveOnly(custom_item,".dom_select_show.time li.active")}date_preset="this%5fmonth"}function createApiUrl(e,t){return`https://graph.facebook.com/v22.0/act_${adAccountId}/insights?fields=${e}&filtering=${t}&time_range={"since":"${startDate}","until":"${endDate}"}&access_token=${accessToken}&limit=1000`}async function fetchDataFlat(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();let n={};a.data.forEach((e=>{const t=e.publisher_platform||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawChart2(n)}catch(e){}}function capitalizeFirstLetter(e){return e.replace(/\b\w/g,(e=>e.toUpperCase()))}searchInput.addEventListener("input",debouncedFilter),switchBtns.forEach(((e,t)=>{e.addEventListener("click",(()=>{setActiveOnly(e,".dom_switch_btns p.active"),0===t?renderTopCampaign(dataCampaignNow):renderTopAdset(dataAdsetNow)}))})),document.addEventListener("change",(function(e){if("dom_select_all"===e.target.id){const t=e.target.checked;document.querySelectorAll(".dom_select_row").forEach((e=>{e.checked=t;const a=e.closest("tr");a&&a.classList.toggle("checked",t)}))}else if(e.target.classList.contains("dom_select_row")){const t=e.target.closest("tr");t&&t.classList.toggle("checked",e.target.checked);const a=document.querySelectorAll(".dom_select_row"),n=document.querySelectorAll(".dom_select_row:checked");document.getElementById("dom_select_all").checked=a.length>0&&a.length===n.length}updateFooterOnCheck(tableDataGlobal)})),apply_custom_date.addEventListener("click",(()=>{const e=document.getElementById("start").value,t=document.getElementById("end").value;e&&t?new Date(e)>new Date(t)?alert("Start date cannot be later than the end date."):(startDate=e,endDate=t,setActiveOnly(custom_item,".dom_select_show.time li.active"),selecedTextTime.textContent="Custom Date",date_preset="custom_date",mainApp()):alert("Please select both start and end dates.")})),selecItemTime.addEventListener("click",(e=>{e.target===selecItemTime&&selecItemTime.classList.toggle("active")})),timeItems.forEach(((e,t)=>{e.addEventListener("click",(()=>{t!=timeItems.length-1&&(e.classList.contains("active")?selecItemTime.classList.remove("active"):(setActiveOnly(e,".dom_select_show.time li.active"),selecedTextTime.textContent=e.textContent.trim(),date_preset=e.dataset.date,mainApp()))}))})),selecItemDaily.addEventListener("click",(e=>{selecItemDaily.classList.toggle("active");const t=e.target.closest("li");if(t){setActiveOnly(t,".dom_select_show.daily li.active");const e=t.dataset.view;selecItemDailyText.textContent=e,updateChart(e)}})),menu.addEventListener("click",(e=>{const t=e.target.closest("li");if(!t||t.classList.contains("active"))return;setActiveOnly(t,".dom_main_menu li.active"),isViewPerformance=!1,dom.classList.remove("isViewPerformance");switch(Array.from(t.parentElement.children).indexOf(t)){case 0:showPerformanceTab(),domContent.classList.remove("none"),domPayment.classList.add("none"),useData(dataFullAdset,!0),removeActiveOnly(".dom_sub_menu li.active"),blockSpentChart.classList.remove("none"),switchBtns[0].click(),localStorage.removeItem("viewPerformance");break;case 1:handleViewPerformance(),domContent.classList.remove("none"),domPayment.classList.add("none");break;case 2:showPaymentTab()}})),selectCampaignList.addEventListener("click",(e=>{const t=e.target.closest(".campaign-item");if(!t)return;const a=Number(t.dataset.index);if(a===activeCampaignID)return;const n=t.dataset.name||"Data for all campaigns",o=document.querySelector(".campaign-item.active");if(o&&o.classList.remove("active"),t.classList.add("active"),activeCampaignID=a,selecedTextCampaign.textContent!==n&&(selecedTextCampaign.textContent=n),adsetNOW="",campaignNOW=a>0?n:"",selectAdset.classList.toggle("show",a>0),a>0){renderAdsetinCampaign(dataFullAdset.filter((e=>e.campaign_name===n))),"Data for all adsets"!==selecedTextAdset?.textContent&&(selecedTextAdset.textContent="Data for all adsets")}blockSpentChart.classList.remove("none");viewFilter(quickFilterData(quickFilter[quickID],campaignNOW,adsetNOW))})),selectAdsetList.addEventListener("click",(e=>{const t=e.target.closest(".adset-item");if(!t||t.classList.contains("active"))return;document.querySelector(".adset-item.active")?.classList.remove("active"),t.classList.add("active");const a=t.dataset.name||"Data for all adsets";selecedTextAdset.textContent!==a&&(selecedTextAdset.textContent=a),adsetNOW=t.dataset.index>0?a:"",blockSpentChart.classList.toggle("none",""!==adsetNOW);viewFilter(quickFilterData(quickFilter[quickID],campaignNOW,adsetNOW))})),renderTableHead(),fetchAdAccountActivities(),getStartEndFromURL(),mainApp();let ageGenderChartInstance,regionChartInstance,genderChartInstance,reachChartInstance=null;function drawChart2(e){const t=document.getElementById("reachChart").getContext("2d"),a=["audience_network","facebook","instagram","messenger"].reduce(((t,a)=>(e[a]&&(t[a]=e[a]),t)),{}),n=Object.keys(a).map((e=>capitalizeFirstLetter(e))),o=Object.values(a);reachChartInstance&&reachChartInstance.destroy(),reachChartInstance=new Chart(t,{type:"pie",data:{labels:n,datasets:[{label:"Total Reach",data:o,backgroundColor:["#ffab00","#262a53","#cccccc","#ffc756"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"bottom",align:"center",labels:{boxWidth:20,padding:15,maxWidth:200,usePointStyle:!0}},title:{display:!1}}}})}async function fetchRegionData(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.region||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawRegionChart(n)}catch(e){}}function drawAgeGenderChart(e,t,a){const n=document.getElementById("ageGenderChart").getContext("2d");ageGenderChartInstance&&ageGenderChartInstance.destroy(),ageGenderChartInstance=new Chart(n,{type:"bar",data:{labels:e,datasets:[{label:"Male",data:t,backgroundColor:"#202449ed"},{label:"Female",data:a,backgroundColor:"#ffab00e3"}]},options:{borderRadius:5,responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}},scales:{x:{stacked:!1},y:{beginAtZero:!0}},barPercentage:.8}})}function drawRegionChart(e){const t=document.getElementById("regionChart").getContext("2d"),a=.015*Object.values(e).reduce(((e,t)=>e+1*t),0),n=Object.entries(e).filter((([,e])=>e>=a));if(0===n.length)return;const o=n.map((([e])=>e.replace(/\s*(Province|City)$/i,"").trim())),s=n.map((([,e])=>e));regionChartInstance&&regionChartInstance.destroy(),regionChartInstance=new Chart(t,{type:"bar",data:{labels:o,datasets:[{data:s,backgroundColor:["#ffb524","#ffb524","#ffb524","#ffb524","#ffb524"],borderWidth:1}]},options:{responsive:!0,borderRadius:5,plugins:{legend:{position:"top",display:!1}},scales:{y:{beginAtZero:!0}},barPercentage:.6}})}async function fetchGenderData(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP Error! Status: ${t.status}`);const a=await t.json();let n={};a.data.forEach((e=>{const t=e.gender||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawGenderChart(n)}catch(e){}}function drawGenderChart(e){const t=document.getElementById("genderChart").getContext("2d"),a=Object.keys(e).map((e=>capitalizeFirstLetter(e))),n=Object.values(e);genderChartInstance&&genderChartInstance.destroy(),genderChartInstance=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Lượt Reach theo giới tính",data:n,backgroundColor:["#ffab00","#262a53","#cccccc"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"bottom",align:"center",labels:{boxWidth:20,padding:15,maxWidth:200,usePointStyle:!0}}}}})}async function fetchImpressionData(e){try{const t=await fetch(e),a=await t.json();if(!a.data||!Array.isArray(a.data))return;handleImpressionDevide(a.data.reduce(((e,t)=>{const a=t.impression_device,n=parseInt(t.impressions,10);return e[a]=(e[a]||0)+n,e}),{}))}catch(e){}}const impression_chart_ul=document.querySelector(".dom_toplist.device");function handleImpressionDevide(e){if(e){const t=Object.entries(e).sort(((e,t)=>t[1]-e[1]));let a="";const n=t.length>0&&t[0][1];t.forEach((([e,t])=>{const o=t/n*100;a+=`<li>\n                  <p><span>${formatLabel(e)}</span> <span>${formatNumber(t)}</span></p>\n                  <p><span style="width: ${o}%"></span></p>\n                </li>`})),impression_chart_ul.innerHTML=a}}const formatLabel=e=>e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" ");async function fetchDataAge(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.age||"Unknown",a=e.gender||"Unknown",o=e.reach||0,s=`${t}_${a}`;n[s]||(n[s]=0),n[s]+=o}));const o=[...new Set(a.data.map((e=>e.age)))].sort(),s=o.map((e=>n[`${e}_male`]||0)),r=o.map((e=>n[`${e}_female`]||0));drawAgeGenderChart(o,s,r)}catch(e){}}function handleViewDemographic(e,t){loading.classList.add("active"),demoTitleAdset.textContent=t,demoTitleCampaign.textContent=e,dom_demographic.classList.add("active");const a=[{field:"campaign.name",operator:"EQUAL",value:e},{field:"adset.name",operator:"EQUAL",value:t}],n=JSON.stringify(a),o={platform:fetchDataFlat,age:fetchDataAge,region:fetchRegionData,gender:fetchGenderData,device:fetchImpressionData,hourly:fetchHourlyData};Object.entries({platform:"campaign_name,reach&breakdowns=publisher_platform",age:"campaign_name,reach&breakdowns=age,gender",region:"campaign_name,reach&breakdowns=region",gender:"campaign_name,reach&breakdowns=gender",device:"campaign_name,impressions&breakdowns=impression_device",hourly:"campaign_name,impressions,spend&breakdowns=hourly_stats_aggregated_by_advertiser_time_zone"}).forEach((([e,t])=>{const a=createApiUrl(t,n);o[e](a)}))}async function fetchAdAccountActivities(){let e=`https://graph.facebook.com/v22.0/act_${adAccountId}?fields=balance,age,created_time,fb_entity,tax_id,id,name,account_status,currency,amount_spent,funding_source_details,spend_cap,business,owner,timezone_name,disable_reason&access_token=${accessToken}`;try{const t=await fetch(e);renderDomPayment(await t.json())}catch(e){}}function renderDomPayment(e){const t=e.funding_source_details?.display_string.includes("VISA");domPayment.innerHTML=`\n      <div class="dom_block">\n          <div class="dom_block_item w25">\n            <h2>Current Debt Balance</h2>\n            <div class="dom_balance">\n              <p>\n                <i class="fa-solid fa-money-check-dollar"></i>\n                <span class="dom_balance_current">${formatCurrency(e.balance)}</span>\n                <span>+5% VAT</span>\n              </p>\n              <div>\n                <p>Total Account Spent</p>\n                <p class="dom_balance_total">${formatCurrency(e.amount_spent)} <span>(Inc. VAT)</span></p>\n              </div>\n            </div>\n          </div>\n\n          <div class="dom_block_item w25">\n            <h2>Payment info</h2>\n            <div class="dom_payment_info">\n            <p> \n      <img src="https://ampersand-reports-dom.netlify.app/DOM-img/${t?"visa.png":"mastercard.png"}" />\n      <span>${e.funding_source_details.display_string}</span>\n    </p>\n              <p>Currency: ${e.currency}</p>\n              <p>Spend cap: ${0==e.spend_cap?"No limit":formatCurrency(e.spend_cap)}</p>\n            </div>\n          </div>\n          <div class="dom_block_item w50">\n            <h2><i class="fa-solid fa-circle-info"></i> Account Info</h2>\n            <div class="dom_account_info">\n              <ul>\n                <li>Account</li>\n                <li>Account Name: ${e.name}</li>\n                <li>Account ID: ${e.id}</li>\n                <li>Create Time: ${e.created_time.split("T")[0]}</li>\n              </ul>\n              <ul>\n                <li>Business</li>\n                <li>Business Name: ${e.business.name}</li>\n                <li>Business ID: ${e.business.id}</li>\n                <li>Time Zone: ${e.timezone_name}</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n  `}
