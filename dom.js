const brandData={labels:["Haagen Dazs","Snowee","Esta","TRB","BEAN","Le Petit"],datasets:[{data:[],backgroundColor:["#ffa900","#ffa900","#ffa900","#ffa900","#ffa900","#ffa900"],borderWidth:1}]};let currentChart=null;function drawChart(e){const t=document.getElementById("brandChart").getContext("2d");null!==currentChart&&currentChart.destroy(),currentChart=new Chart(t,{type:"bar",data:e,options:{responsive:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}const accessToken="EAAQwS9m6tIABO8ZCZCvO4TtPBXcbilAYn3nwZCZB739B8GtMfy2V2uJmgjHMtvsdKS6XMl7YiBuXqg3BxTdh37H7Vv5qYcsZA7IqVYMLqHX3FhQdxD8fSguISa0sDg1INzOfVtUCt8OoNqh0j6PXvu50rZCgMerGZAJ7NAYgLYuTsPw8NvdOEdF5kRX9C0ctu1ka7CS6VcbbXosWnMM",adAccountId="676599667843841",apiUrl=`https://graph.facebook.com/v16.0/act_${adAccountId}/campaigns?fields=id,name,status,adsets{campaign_id,name,status,spend,insights.date_preset(last%5f7d){impressions,reach,spend,actions,cost_per_action_type}}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}`;let allData=[];async function fetchData(e){allData=[];try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;allData=a.data,renderTopCampaigns(allData);const n=calculateTotals(allData);document.getElementById("total_spend").textContent=formatCurrency(Math.round(n.spend)),document.getElementById("total_reach").textContent=formatNumber(Math.round(n.reach)),document.getElementById("total_reaction").textContent=formatNumber(Math.round(n.reaction)),document.getElementById("total_follows").textContent=formatNumber(Math.round(n.follows));const r=calculateBrandSpending(allData,brandData.labels);brandData.datasets[0].data=r,drawChart(brandData),processData(allData)}catch(e){}}function processData(e){let t="";const a=document.querySelector(".dom_detail_tbody ");function n(e,t=0){let a=0,n=0,r=0,o=0,s=0,c=0,d=0,l=0,i=0;e.forEach((e=>{a+=parseFloat(e.querySelector(".spend").dataset.value)||0,n+=parseInt(e.querySelector(".reach").dataset.value)||0,c+=parseInt(e.querySelector(".result").dataset.value)||0,r+=parseInt(e.querySelector(".impressions").dataset.value)||0,o+=parseInt(e.querySelector(".postReaction").dataset.value)||0,s+=parseInt(e.querySelector(".follows").dataset.value)||0,d+=parseInt(e.querySelector(".comments").dataset.value)||0,l+=parseInt(e.querySelector(".linkClick").dataset.value)||0,i+=parseInt(e.querySelector(".messengerStart").dataset.value)||0}));const u=`\n      <tr>\n        <td class="dom_selected_total" colspan="4">\n          ${t>0?`Total selected ${t} adsets`:"Total all adsets"}\n        </td>\n        <td>${formatCurrency(a)}</td>\n        <td>${formatNumber(n)}</td>\n        <td>${formatNumber(r)}</td>\n        <td>${formatNumber(c)}</td>\n        <td>${c?formatCurrency(Math.floor(a/c)):"-"}</td>\n        <td>-</td>\n        <td>${formatNumber(o)}</td>\n        <td>${formatNumber(d)}</td>\n        <td>${formatNumber(s)}</td>\n        <td>${formatNumber(i)}</td>\n        <td>${formatNumber(l)}</td>\n      </tr>\n    `;document.querySelector("tfoot").innerHTML=u;if(document.querySelector("#dom_contentarea.viewPerformance")){const e=document.getElementById("total_spend_viewPerformance"),t=document.getElementById("total_reach_viewPerformance"),r=document.getElementById("total_messenger_viewPerformance"),o=document.getElementById("total_follows_viewPerformance");e.innerText=formatCurrency(a),t.innerText=formatNumber(n),r.innerText=formatNumber(i),o.innerText=formatNumber(s)}}document.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target.closest("tr");e.target.checked?t.classList.add("checked"):t.classList.remove("checked");const a=Array.from(document.querySelectorAll("tr.checked"));if(a.length>0)n(a,a.length);else{n(Array.from(document.querySelectorAll("tbody tr")))}}})),e.forEach((e=>{e.adsets.data.forEach((a=>{const n=a.insights?a.insights.data[0]:{},r=parseFloat(n.spend)||0;if(r>0){const o=n.reach||0,s=n.impressions||0,c=getValueFromActions(n.actions,"post_reaction")||0,d=getValueFromActions(n.actions,"like")||0,l=getValueFromActions(n.actions,"comment")||0,i=getValueFromActions(n.actions,"link_click")||0,u=getValueFromActions(n.actions,"onsite_conversion.messaging_conversation_started_7d")||0;let m=0;e.name.toLowerCase().includes("engagement")&&(m=parseInt(c)),e.name.toLowerCase().includes("awareness")&&(m=parseInt(o)),e.name.toLowerCase().includes("message")&&(m=parseInt(u)),e.name.toLowerCase().includes("likepage")&&(m=parseInt(d));const f=m>0?Math.round(r/m):"-",p=s>0?Math.round(r/s*1e3):0,h=formatCurrency(f),g=formatCurrency(p);t+=`\n          <tr>\n            <td><input type="checkbox"></td>\n            <td>${e.name}</td>\n            <td>${a.name}</td>\n            <td class="${"ACTIVE"===a.status?"dom_status_active":"dom_status_inactive"}">\n              ${formatStatus(a.status)}\n            </td>\n            <td class="spend" data-value="${r}">${formatCurrency(r)}</td>\n            <td class="reach" data-value="${o}">${formatNumber(o)}</td>\n            <td class="impressions" data-value="${s}">${formatNumber(s)}</td>\n            <td class="result" data-value="${m}">${m>0?formatNumber(m):"-"}</td>\n            <td class="costPerResult" data-value="${f}">${h}</td>\n            <td class="cpm" data-value="${p}">${g}</td>\n            <td class="postReaction" data-value="${c}">${formatNumber(c)}</td>\n            <td class="comments" data-value="${l}">${formatNumber(l)}</td>\n            <td class="follows" data-value="${d}">${formatNumber(d)}</td>\n            <td class="messengerStart" data-value="${u}">${formatNumber(u)}</td>\n            <td class="linkClick" data-value="${i}">${formatNumber(i)}</td>\n          </tr>\n        `}}))})),a.innerHTML=t,sortTableBySpend();n(Array.from(document.querySelectorAll("tbody tr")));const r=localStorage.getItem("quickID");if(r){document.querySelectorAll(".dom_quick_filter a")[r].click()}}function sortTableBySpend(){const e=document.querySelector("tbody"),t=Array.from(e.querySelectorAll("tr"));t.sort(((e,t)=>{const a=parseFloat(e.querySelector(".spend").dataset.value)||0;return(parseFloat(t.querySelector(".spend").dataset.value)||0)-a})),e.innerHTML="",t.forEach((t=>e.appendChild(t)))}const dom_main_menu_a=document.querySelectorAll(".dom_main_menu li a"),dom_contentarea=document.querySelector("#dom_contentarea");function clearFilter(){const e=document.querySelector(".dom_quick_filter a.active");e&&e.classList.remove("active"),localStorage.removeItem("quickID")}function filterData(e){processData(allData.filter((t=>t.name.toLowerCase().includes(e))))}function formatStatus(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function formatCurrency(e){return"-"===e?"-":new Intl.NumberFormat("vi-VN").format(e)+" ₫"}function formatNumber(e){return"-"===e?"-":new Intl.NumberFormat("de-DE").format(e)}function getValueFromActions(e,t){if(!e)return"0";const a=e.find((e=>e.action_type===t));return a?a.value:"0"}function calculateBrandSpending(e,t){const a=t.map((()=>0));return e.forEach((e=>{const n=e.name.toLowerCase(),r=e.adsets.data.reduce(((e,t)=>e+parseFloat(t.insights?.data[0]?.spend||0)),0);t.forEach(((e,t)=>{n.includes(e.toLowerCase())&&(a[t]+=r)}))})),a}function calculateTotals(e){const t={spend:0,reach:0,reaction:0,follows:0};return e.forEach((e=>{e.adsets.data.forEach((e=>{const a=e.insights?.data[0]||{};t.spend+=parseFloat(a.spend||0),t.reach+=parseInt(a.reach||0),t.reaction+=parseInt(getValueFromActions(a.actions,"post_reaction")||0,10),t.follows+=parseInt(getValueFromActions(a.actions,"like")||0,10)}))})),t}function renderTopCampaigns(e){const t=e.map((e=>{const t=e.adsets.data.reduce(((e,t)=>e+parseFloat(t.insights?.data[0]?.spend||0)),0);return{name:e.name,spend:t}}));t.sort(((e,t)=>t.spend-e.spend));const a=document.querySelector(".dom_chart_most_ul");a.innerHTML="",t.forEach((e=>{const t=document.createElement("li");t.innerHTML=`<span>${e.name}</span> <span>${formatCurrency(e.spend)}</span>`,a.appendChild(t)}))}document.getElementById("dom_detail_find").addEventListener("click",(function(){const e=document.getElementById("dom_detail_input").value.toLowerCase().trim();clearFilter(),dom_contentarea.classList.remove("viewPerformance"),filterData(e)})),fetchData(apiUrl);const dom_choose_day=document.querySelector(".dom_choose_day"),dom_choosed=document.querySelector(".dom_choosed"),dom_choosed_day=document.querySelector(".dom_choosed_day");dom_choose_day.addEventListener("click",(function(){dom_choose_day.classList.toggle("active")}));let preset="last%5f7d";const itemDate=document.querySelectorAll(".dom_choose_day li");function formatDate(e){const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`}function getFormattedDateRange(e){const t=new Date;let a,n;switch(e){case"today":a=n=t;break;case"yesterday":a=new Date,a.setDate(t.getDate()-1),n=a;break;case"last%5f3d":a=new Date,a.setDate(t.getDate()-3),n=new Date,n.setDate(t.getDate()-1);break;case"last%5f7d":a=new Date,a.setDate(t.getDate()-7),n=new Date,n.setDate(t.getDate()-1);break;case"this%5fmonth":a=new Date(t.getFullYear(),t.getMonth(),1),n=t;break;case"last%5fmonth":a=new Date(t.getFullYear(),t.getMonth()-1,1),n=new Date(t.getFullYear(),t.getMonth(),0);break;default:return""}return a.getTime()===n.getTime()?formatDate(a):`${formatDate(a)} - ${formatDate(n)}`}itemDate.forEach((e=>{e.addEventListener("click",(()=>{dom_choosed.innerText=e.innerText;const t=e.getAttribute("data-date"),a=getFormattedDateRange(t);dom_choosed_day.innerText=a;const n=`https://graph.facebook.com/v16.0/act_${adAccountId}/campaigns?fields=id,name,status,adsets{campaign_id,name,status,spend,insights.date_preset(${t}){impressions,reach,spend,actions,cost_per_action_type}}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}`;preset=t,fetchData(n)}))})),dom_choosed_day.innerText=getFormattedDateRange("last%5f7d");const quick_filter=["Haagen Dazs","Snowee","Esta","TRB","BEAN","Le Petit"],dom_quick_filter=document.querySelector(".dom_quick_filter"),dom_table_data=document.querySelector(".dom_table_data");quick_filter.forEach((e=>{const t=document.createElement("li");t.innerHTML=`\n    <a class="" data-quick="${e}">\n      <i class="fa-solid fa-bolt"></i> <span>${e}</span>\n    </a>\n  `,dom_quick_filter.appendChild(t)}));const filterItems=document.querySelectorAll(".dom_quick_filter a");function createApiUrl(e,t,a,n,r){return`https://graph.facebook.com/v16.0/act_${t}/insights?fields=${e}&filtering=${a}&date_preset=${n}&access_token=${r}`}function viewPerformance(){dom_contentarea.classList.add("viewPerformance");localStorage.getItem("quickID")||filterItems[0].click()}async function fetchDataAge(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.age||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawAgeChart3(n)}catch(e){}}async function fetchDataFlat(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.publisher_platform||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawChart2(n)}catch(e){}}function capitalizeFirstLetter(e){return e.replace(/\b\w/g,(e=>e.toUpperCase()))}filterItems.forEach(((e,t)=>{e.addEventListener("click",(()=>{dom_main_menu_a[1].click();const a=document.querySelector(".dom_quick_filter a.active");a&&a.classList.remove("active"),localStorage.setItem("quickID",t),localStorage.setItem("query",e.dataset.quick),e.classList.add("active");const n=JSON.stringify([{field:"campaign.name",operator:"CONTAIN",value:e.dataset.quick}]),r={platform:createApiUrl("campaign_id,campaign_name,reach&breakdowns=publisher_platform",adAccountId,n,preset,accessToken),age:createApiUrl("campaign_id,campaign_name,reach&breakdowns=age",adAccountId,n,preset,accessToken),region:createApiUrl("campaign_id,campaign_name,reach&breakdowns=region",adAccountId,n,preset,accessToken),gender:createApiUrl("campaign_id,campaign_name,reach&breakdowns=gender",adAccountId,n,preset,accessToken),daily:createApiUrl("spend,reach,actions,date_start&time_increment=1",adAccountId,n,preset,accessToken)};fetchDataFlat(r.platform),fetchDataAge(r.age),fetchRegionData(r.region),fetchGenderData(r.gender),fetchDailyInsights(r.daily),filterData(e.dataset.quick.toLowerCase())}))})),dom_main_menu_a.forEach(((e,t)=>{e.addEventListener("click",(()=>{const a=document.querySelector(".dom_main_menu li a.active");a&&a.classList.remove("active"),e.classList.add("active"),0==t&&(clearFilter(),filterData(""),dom_contentarea.classList.remove("viewPerformance"),window.scroll(0,0)),1==t&&viewPerformance()}))}));let ageChartInstance,regionChartInstance,genderChartInstance,dailyChartInstance,reachChartInstance=null;function drawChart2(e){const t=document.getElementById("reachChart").getContext("2d"),a=["audience_network","facebook","instagram","messenger"].reduce(((t,a)=>(e[a]&&(t[a]=e[a]),t)),{}),n=Object.keys(a).map((e=>capitalizeFirstLetter(e))),r=Object.values(a);reachChartInstance&&reachChartInstance.destroy(),reachChartInstance=new Chart(t,{type:"pie",data:{labels:n,datasets:[{label:"Total Reach",data:r,backgroundColor:["#cccccc","#ffab00","#ffc756","#262a53"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}}}})}function drawAgeChart3(e){const t=document.getElementById("ageChart").getContext("2d"),a=Object.keys(e),n=Object.values(e);ageChartInstance&&ageChartInstance.destroy(),ageChartInstance=new Chart(t,{type:"bar",data:{labels:a,datasets:[{data:n,backgroundColor:["#ffab00","#ffab00","#ffab00","#ffab00","#ffab00"],borderWidth:1}]},options:{responsive:!0,plugins:{legend:{position:"top",display:!1}},scales:{y:{beginAtZero:!0}}}})}async function fetchRegionData(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.region||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawRegionChart(n)}catch(e){}}function drawRegionChart(e){const t=document.getElementById("regionChart").getContext("2d"),a=Object.keys(e),n=Object.values(e);regionChartInstance&&regionChartInstance.destroy(),regionChartInstance=new Chart(t,{type:"bar",data:{labels:a,datasets:[{data:n,backgroundColor:["#ffab00","#ffab00","#ffab00","#ffab00","#ffab00"],borderWidth:1}]},options:{responsive:!0,plugins:{legend:{position:"top",display:!1}},scales:{y:{beginAtZero:!0}}}})}async function fetchGenderData(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const a=await t.json();if(a.error)return;let n={};a.data.forEach((e=>{const t=e.gender||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawGenderChart(n)}catch(e){}}function drawGenderChart(e){const t=document.getElementById("genderChart").getContext("2d"),a=Object.keys(e).map((e=>capitalizeFirstLetter(e))),n=Object.values(e);genderChartInstance&&genderChartInstance.destroy(),genderChartInstance=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Lượt Reach theo giới tính",data:n,backgroundColor:["#262a53","#ffab00","#cccccc"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"top"}}}})}async function fetchDailyInsights(e){try{const t=await fetch(e),a=t.headers.get("content-type");if(!a||!a.includes("application/json")){const e=await t.text();throw new Error(`Invalid JSON response: ${e}`)}const n=await t.json();if(n.error)return;let r=[],o=[],s=[],c=[];n.data.forEach((e=>{const t=e.date_start,a=parseFloat(e.spend)||0,n=parseFloat(e.reach)||0;let d=0;e.actions&&e.actions.forEach((e=>{"onsite_conversion.messaging_conversation_started_7d"===e.action_type&&(d=e.value||0)})),r.push(t),o.push(a),s.push(n),c.push(d)})),drawDailyChart(r,o,s,c)}catch(e){}}function drawDailyChart(e,t,a,n){const r=document.getElementById("dailyChart").getContext("2d");dailyChartInstance&&dailyChartInstance.destroy(),dailyChartInstance=new Chart(r,{type:"line",data:{labels:e,datasets:[{label:"Cost spend",data:t,borderColor:"#FFC300",fill:!0,backgroundColor:"rgba(255, 195, 0, 0.3)",tension:.1},{label:"Daily Reach",data:a,borderColor:"#FFC300",fill:!0,backgroundColor:"rgba(255, 195, 0, 0.3)",tension:.1},{label:"Message",data:n,borderColor:"#FFC300",fill:!0,backgroundColor:"rgba(255, 195, 0, 0.3)",tension:.1}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}}}})}
