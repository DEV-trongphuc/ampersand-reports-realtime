const brandData={labels:["Haagen Dazs","Snowee","Esta","TRB","BEAN","Le Petit"],datasets:[{data:[],backgroundColor:["#ffa900","#ffa900","#ffa900","#ffa900","#ffa900","#ffa900"],borderWidth:1}]};let currentChart=null;function drawChart(e){const t=document.getElementById("brandChart").getContext("2d");null!==currentChart&&currentChart.destroy(),currentChart=new Chart(t,{type:"bar",data:e,options:{responsive:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}const accessToken="EAAQwS9m6tIABO8ZCZCvO4TtPBXcbilAYn3nwZCZB739B8GtMfy2V2uJmgjHMtvsdKS6XMl7YiBuXqg3BxTdh37H7Vv5qYcsZA7IqVYMLqHX3FhQdxD8fSguISa0sDg1INzOfVtUCt8OoNqh0j6PXvu50rZCgMerGZAJ7NAYgLYuTsPw8NvdOEdF5kRX9C0ctu1ka7CS6VcbbXosWnMM",adAccountId="676599667843841",apiUrl=`https://graph.facebook.com/v16.0/act_${adAccountId}/campaigns?fields=id,name,status,adsets{campaign_id,name,status,spend,insights.date_preset(last%5f7d){impressions,reach,spend,actions,cost_per_action_type}}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}`;let allData=[];async function fetchData(e){allData=[];let t=e;document.querySelector(".loading").classList.add("active");try{for(;t;){const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const a=await e.json();if(a.error)return void document.querySelector(".loading").classList.remove("active");allData=[...allData,...a.data],t=a.paging&&a.paging.next?a.paging.next:null}renderTopCampaigns(allData);const e=calculateTotals(allData);document.getElementById("total_spend").textContent=formatCurrency(Math.round(e.spend)),document.getElementById("total_reach").textContent=formatNumber(Math.round(e.reach)),document.getElementById("total_reaction").textContent=formatNumber(Math.round(e.reaction)),document.getElementById("total_follows").textContent=formatNumber(Math.round(e.follows));const a=calculateBrandSpending(allData,brandData.labels);brandData.datasets[0].data=a,document.querySelector(".loading").classList.remove("active"),drawChart(brandData),processData(allData);localStorage.getItem("quickID")&&renderReportPerformance(1*localStorage.getItem("quickID"))}catch(e){}}const dom_reach_unit=document.getElementById("dom_reach_unit"),dom_reaction_unit=document.getElementById("dom_reaction_unit"),dom_mess_unit=document.getElementById("dom_mess_unit"),dom_like_unit=document.getElementById("dom_like_unit");function processData(e,t){let a="";const n=document.querySelector(".dom_detail_tbody ");function o(e,t=0){let a=0,n=0,o=0,r=0,c=0,s=0,d=0,l=0,i=0,m=0;e.forEach((e=>{a+=parseFloat(e.querySelector(".spend").dataset.value)||0,n+=parseInt(e.querySelector(".reach").dataset.value)||0,d+=parseInt(e.querySelector(".result").dataset.value)||0,o+=parseInt(e.querySelector(".impressions").dataset.value)||0,r+=parseInt(e.querySelector(".engagement").dataset.value)||0,c+=parseInt(e.querySelector(".postReaction").dataset.value)||0,s+=parseInt(e.querySelector(".follows").dataset.value)||0,l+=parseInt(e.querySelector(".comments").dataset.value)||0,i+=parseInt(e.querySelector(".linkClick").dataset.value)||0,m+=parseInt(e.querySelector(".messengerStart").dataset.value)||0}));const u=`\n      <tr>\n        <td class="dom_selected_total" colspan="4">\n          ${t>0?`Total selected ${t} adsets`:"Total all adsets"}\n        </td>\n        <td>${formatCurrency(a)}</td>\n        <td>${formatNumber(n)}</td>\n        <td>${formatNumber(o)}</td>\n        <td>${formatNumber(d)}</td>\n        <td>${d?formatCurrency(Math.floor(a/d)):"-"}</td>\n        <td>-</td>\n        <td>${formatNumber(r)}</td>\n        <td>${formatNumber(c)}</td>\n        <td>${formatNumber(l)}</td>\n        <td>${formatNumber(s)}</td>\n        <td>${formatNumber(m)}</td>\n        <td>${formatNumber(i)}</td>\n      </tr>\n    `;document.querySelector("tfoot").innerHTML=u;if(document.querySelector("#dom_contentarea.viewPerformance")){const e=document.getElementById("total_spend_viewPerformance"),t=document.getElementById("total_reaction_viewPerformance"),o=document.getElementById("total_engagement_viewPerformance"),d=document.getElementById("total_reach_viewPerformance"),u=document.getElementById("total_messenger_viewPerformance"),g=document.getElementById("total_follows_viewPerformance"),f=document.getElementById("total_comment_viewPerformance"),p=document.getElementById("total_link_viewPerformance");e.innerText=formatCurrency(a),d.innerText=formatNumber(n),u.innerText=formatNumber(m),g.innerText=formatNumber(s),t.innerText=formatNumber(c),o.innerText=formatNumber(r),f.innerText=formatNumber(l),p.innerText=formatNumber(i)}}document.addEventListener("change",(e=>{if("checkbox"===e.target.type){const t=e.target.closest("tr");e.target.checked?t.classList.add("checked"):t.classList.remove("checked");const a=Array.from(document.querySelectorAll("tr.checked"));if(a.length>0)o(a,a.length);else{o(Array.from(document.querySelectorAll("tbody tr")))}}}));let r=0,c=0,s=0,d=0,l=0,i=0,m=0,u=0;e.forEach((e=>{e.adsets.data.forEach((n=>{const o=n.insights?n.insights.data[0]:{},g=parseFloat(o.spend)||0;if(g>0){const f=o.reach||0,p=o.impressions||0,h=getValueFromActions(o.actions,"post_engagement")||0,_=getValueFromActions(o.actions,"post_reaction")||0,y=getValueFromActions(o.actions,"like")||0,b=getValueFromActions(o.actions,"comment")||0,w=getValueFromActions(o.actions,"link_click")||0,C=getValueFromActions(o.actions,"onsite_conversion.messaging_conversation_started_7d")||0;"true"===t&&(e.name.toLowerCase().includes("awareness")&&(r+=parseFloat(o.spend)||0,c+=parseInt(o.reach)||0),e.name.toLowerCase().includes("engagement")&&(s+=parseFloat(o.spend)||0,d+=getValueFromActions(o.actions,"post_reaction")||0),e.name.toLowerCase().includes("message")&&(l+=g,i+=getValueFromActions(o.actions,"onsite_conversion.messaging_conversation_started_7d")||0),e.name.toLowerCase().includes("likepage")&&(m+=g,u+=getValueFromActions(o.actions,"like")||0));let k=0;e.name.toLowerCase().includes("engagement")&&(k=parseInt(_)),e.name.toLowerCase().includes("awareness")&&(k=parseInt(f)),e.name.toLowerCase().includes("message")&&(k=parseInt(C)),e.name.toLowerCase().includes("likepage")&&(k=parseInt(y));const v=k>0?Math.round(g/k):"-",I=p>0?Math.round(g/p*1e3):0,D=formatCurrency(v),E=formatCurrency(I),S=formatNumber(h);a+=`\n          <tr>\n            <td><input type="checkbox"></td>\n            <td>${e.name}</td>\n            <td>${n.name}</td>\n            <td class="${"ACTIVE"===n.status?"dom_status_active":"dom_status_inactive"}">\n              ${formatStatus(n.status)}\n            </td>\n            <td class="spend" data-value="${g}">${formatCurrency(g)}</td>\n            <td class="reach" data-value="${f}">${formatNumber(f)}</td>\n            <td class="impressions" data-value="${p}">${formatNumber(p)}</td>\n            <td class="result" data-value="${k}">${k>0?formatNumber(k):"-"}</td>\n            <td class="costPerResult" data-value="${v}">${D}</td>\n            <td class="cpm" data-value="${I}">${E}</td>\n            <td class="engagement" data-value="${h}">${S}</td>\n            <td class="postReaction" data-value="${_}">${formatNumber(_)}</td>\n            <td class="comments" data-value="${b}">${formatNumber(b)}</td>\n            <td class="follows" data-value="${y}">${formatNumber(y)}</td>\n            <td class="messengerStart" data-value="${C}">${formatNumber(C)}</td>\n            <td class="linkClick" data-value="${w}">${formatNumber(w)}</td>\n          </tr>\n        `}}))})),"true"===t&&(dom_reach_unit.innerText=c>0?formatCurrency((r/c).toFixed(1)):"-",dom_reaction_unit.innerText=d>0?formatCurrency((s/d).toFixed(0)):"-",dom_mess_unit.innerText=i>0?formatCurrency((l/i).toFixed(0)):"-",dom_like_unit.innerText=u>0?formatCurrency((m/u).toFixed(0)):"-"),n.innerHTML=a,sortTableBySpend();o(Array.from(document.querySelectorAll("tbody tr")));const g=localStorage.getItem("quickID"),f=localStorage.getItem("query");if(g&&f){document.querySelectorAll(".dom_quick_filter a")[g].click()}}function sortTableBySpend(){const e=document.querySelector("tbody"),t=Array.from(e.querySelectorAll("tr"));t.sort(((e,t)=>{const a=parseFloat(e.querySelector(".spend").dataset.value)||0;return(parseFloat(t.querySelector(".spend").dataset.value)||0)-a})),e.innerHTML="",t.forEach((t=>e.appendChild(t)))}const dom_main_menu_a=document.querySelectorAll(".dom_main_menu li a"),dom_contentarea=document.querySelector("#dom_contentarea");function clearFilter(){const e=document.querySelector(".dom_quick_filter a.active");e&&e.classList.remove("active"),localStorage.removeItem("quickID")}function filterData(e){processData(allData.filter((t=>t.name.toLowerCase().includes(e))),"true")}function formatStatus(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function formatCurrency(e){return"-"===e?"-":new Intl.NumberFormat("vi-VN").format(e)+" ₫"}function formatNumber(e){return"-"===e?"-":new Intl.NumberFormat("de-DE").format(e)}function getValueFromActions(e,t){if(!e)return 0;const a=e.find((e=>e.action_type===t));return a?1*a.value:0}function calculateBrandSpending(e,t){const a=t.map((()=>0));return e.forEach((e=>{const n=e.name.toLowerCase(),o=e.adsets.data.reduce(((e,t)=>e+parseFloat(t.insights?.data[0]?.spend||0)),0);t.forEach(((e,t)=>{n.includes(e.toLowerCase())&&(a[t]+=o)}))})),a}function calculateTotals(e){const t={spend:0,reach:0,reaction:0,follows:0};return e.forEach((e=>{e.adsets.data.forEach((e=>{const a=e.insights?.data[0]||{};t.spend+=parseFloat(a.spend||0),t.reach+=parseInt(a.reach||0),t.reaction+=parseInt(getValueFromActions(a.actions,"post_reaction")||0,10),t.follows+=parseInt(getValueFromActions(a.actions,"like")||0,10)}))})),t}function renderTopCampaigns(e){const t=e.map((e=>{const t=e.adsets.data.reduce(((e,t)=>e+parseFloat(t.insights?.data[0]?.spend||0)),0);return{name:e.name,spend:t}}));t.sort(((e,t)=>t.spend-e.spend));const a=document.querySelector(".dom_chart_most_ul");a.innerHTML="",t.forEach((e=>{const t=document.createElement("li");t.innerHTML=`<span>${e.name}</span> <span>${formatCurrency(e.spend)}</span>`,a.appendChild(t)}))}document.getElementById("dom_detail_find").addEventListener("click",(function(){const e=document.getElementById("dom_detail_input").value.toLowerCase().trim();clearFilter(),dom_contentarea.classList.remove("viewPerformance"),filterData(e)})),fetchData(apiUrl);const dom_choose_day=document.querySelector(".dom_choose_day"),dom_choosed=document.querySelector(".dom_choosed"),dom_choosed_day=document.querySelector(".dom_choosed_day");dom_choose_day.addEventListener("click",(function(){dom_choose_day.classList.toggle("active")}));let preset="last%5f7d";const itemDate=document.querySelectorAll(".dom_choose_day li");function formatDate(e){const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`}function getFormattedDateRange(e){const t=new Date;let a,n;switch(e){case"today":a=n=t;break;case"yesterday":a=new Date,a.setDate(t.getDate()-1),n=a;break;case"last%5f3d":a=new Date,a.setDate(t.getDate()-3),n=new Date,n.setDate(t.getDate()-1);break;case"last%5f7d":a=new Date,a.setDate(t.getDate()-7),n=new Date,n.setDate(t.getDate()-1);break;case"last%5f30d":a=new Date,a.setDate(t.getDate()-30),n=new Date,n.setDate(t.getDate()-1);break;case"this%5fmonth":a=new Date(t.getFullYear(),t.getMonth(),1),n=t;break;case"last%5fmonth":a=new Date(t.getFullYear(),t.getMonth()-1,1),n=new Date(t.getFullYear(),t.getMonth(),0);break;default:return""}return a.getTime()===n.getTime()?formatDate(a):`${formatDate(a)} - ${formatDate(n)}`}itemDate.forEach((e=>{e.addEventListener("click",(()=>{dom_choosed.innerText=e.innerText;const t=e.getAttribute("data-date"),a=getFormattedDateRange(t);dom_choosed_day.innerText=a;const n=`https://graph.facebook.com/v16.0/act_${adAccountId}/campaigns?fields=id,name,status,adsets{campaign_id,name,status,spend,insights.date_preset(${t}){impressions,reach,spend,actions,cost_per_action_type}}&filtering=[{"field":"spend","operator":"GREATER_THAN","value":0}]&access_token=${accessToken}`;preset=t,fetchData(n)}))})),dom_choosed_day.innerText=getFormattedDateRange("last%5f7d");const quick_filter=["Haagen Dazs","Snowee","Esta","TRB","BEAN","Le Petit"],dom_quick_filter=document.querySelector(".dom_quick_filter"),dom_table_data=document.querySelector(".dom_table_data");quick_filter.forEach((e=>{const t=document.createElement("li");t.innerHTML=`\n    <a class="" data-quick="${e}">\n      <i class="fa-solid fa-bolt"></i> <span>${e}</span>\n    </a>\n  `,dom_quick_filter.appendChild(t)}));const filterItems=document.querySelectorAll(".dom_quick_filter a");function createApiUrl(e,t,a,n,o){return`https://graph.facebook.com/v16.0/act_${t}/insights?fields=${e}&filtering=${a}&date_preset=${n}&access_token=${o}`}const daily_title=document.querySelector(".daily_title");function renderReportPerformance(e){dom_main_menu_a[1].click();const t=document.querySelector(".dom_quick_filter a.active");t&&t.classList.remove("active");const a=filterItems[e].dataset.quick;localStorage.setItem("quickID",e),localStorage.setItem("query",a),filterItems[e].classList.add("active"),daily_title.innerText=`Daily Line Chart - ${a}`;const n=JSON.stringify([{field:"campaign.name",operator:"CONTAIN",value:a},{field:"spend",operator:"GREATER_THAN",value:0}]),o={platform:createApiUrl("campaign_id,campaign_name,reach&breakdowns=publisher_platform",adAccountId,n,preset,accessToken),age:createApiUrl("campaign_id,campaign_name,reach&breakdowns=age,gender",adAccountId,n,preset,accessToken),region:createApiUrl("campaign_id,campaign_name,reach&breakdowns=region",adAccountId,n,preset,accessToken),gender:createApiUrl("campaign_id,campaign_name,reach&breakdowns=gender",adAccountId,n,preset,accessToken),daily:createApiUrl("spend,reach,actions,date_start&time_increment=1",adAccountId,n,preset,accessToken)};fetchDataFlat(o.platform),fetchDataAge(o.age),fetchRegionData(o.region),fetchGenderData(o.gender),fetchDailyInsights(o.daily),filterData(a.toLowerCase())}function viewPerformance(){dom_contentarea.classList.add("viewPerformance");localStorage.getItem("quickID")||filterItems[0].click()}async function fetchDataAge(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();if(n.error)return;t=[...t,...n.data],a=n.paging&&n.paging.next?n.paging.next:null}let n={};t.forEach((e=>{const t=e.age||"Unknown",a=e.gender||"Unknown",o=e.reach||0,r=`${t}_${a}`;n[r]||(n[r]=0),n[r]+=o}));const o=[...new Set(t.map((e=>e.age)))].sort(),r=o.map((e=>n[`${e}_male`]||0)),c=o.map((e=>n[`${e}_female`]||0));drawAgeGenderChart(o,r,c)}catch(e){}}async function fetchDataFlat(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();if(n.error)return;t=[...t,...n.data],a=n.paging&&n.paging.next?n.paging.next:null}let n={};t.forEach((e=>{const t=e.publisher_platform||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawChart2(n)}catch(e){}}function capitalizeFirstLetter(e){return e.replace(/\b\w/g,(e=>e.toUpperCase()))}filterItems.forEach(((e,t)=>{e.addEventListener("click",(()=>{localStorage.getItem("quickID")!=t&&renderReportPerformance(t)}))})),dom_main_menu_a.forEach(((e,t)=>{e.addEventListener("click",(()=>{const a=document.querySelector(".dom_main_menu li a.active");a&&a.classList.remove("active"),e.classList.add("active"),0==t&&(clearFilter(),filterData(""),dom_contentarea.classList.remove("viewPerformance"),window.scroll(0,0)),1==t&&viewPerformance()}))}));let regionChartInstance,genderChartInstance,dailyChartInstance,reachChartInstance=null;function drawChart2(e){const t=document.getElementById("reachChart").getContext("2d"),a=["audience_network","facebook","instagram","messenger"].reduce(((t,a)=>(e[a]&&(t[a]=e[a]),t)),{}),n=Object.keys(a).map((e=>capitalizeFirstLetter(e))),o=Object.values(a);reachChartInstance&&reachChartInstance.destroy(),reachChartInstance=new Chart(t,{type:"pie",data:{labels:n,datasets:[{label:"Total Reach",data:o,backgroundColor:["#cccccc","#ffab00","#ffc756","#262a53"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}}}})}function drawAgeGenderChart(e,t,a){const n=document.getElementById("ageGenderChart").getContext("2d");new Chart(n,{type:"bar",data:{labels:e,datasets:[{label:"Male",data:t,backgroundColor:"#202449ed",borderColor:"#262a53",borderWidth:1},{label:"Female",data:a,backgroundColor:"#ffab00e3",borderColor:"#ffab00",borderWidth:1}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}},scales:{x:{stacked:!1},y:{beginAtZero:!0}}}})}async function fetchRegionData(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();if(n.error)return;t=[...t,...n.data],a=n.paging&&n.paging.next?n.paging.next:null}let n={};t.forEach((e=>{const t=e.region||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawRegionChart(n)}catch(e){}}function drawRegionChart(e){const t=document.getElementById("regionChart").getContext("2d"),a=Object.keys(e),n=Object.values(e);regionChartInstance&&regionChartInstance.destroy(),regionChartInstance=new Chart(t,{type:"bar",data:{labels:a,datasets:[{data:n,backgroundColor:["#ffab00","#ffab00","#ffab00","#ffab00","#ffab00"],borderWidth:1}]},options:{responsive:!0,plugins:{legend:{position:"top",display:!1}},scales:{y:{beginAtZero:!0}}}})}async function fetchGenderData(e){try{let t=[],a=e;for(;a;){const e=await fetch(a);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();if(n.error)return;t=[...t,...n.data],a=n.paging&&n.paging.next?n.paging.next:null}let n={};t.forEach((e=>{const t=e.gender||"Unknown",a=e.reach||0;n[t]||(n[t]=0),n[t]+=a})),drawGenderChart(n)}catch(e){}}function drawGenderChart(e){const t=document.getElementById("genderChart").getContext("2d"),a=Object.keys(e).map((e=>capitalizeFirstLetter(e))),n=Object.values(e);genderChartInstance&&genderChartInstance.destroy(),genderChartInstance=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Lượt Reach theo giới tính",data:n,backgroundColor:["#ffab00","#262a53","#cccccc"],hoverOffset:4}]},options:{responsive:!0,plugins:{legend:{position:"top"}}}})}async function fetchDailyInsights(e){document.querySelector(".loading").classList.add("active");try{let t=[],a=e;for(;a;){const e=await fetch(a),n=await e.json();if(n.error)return void document.querySelector(".loading").classList.remove("active");t=[...t,...n.data],a=n.paging&&n.paging.next?n.paging.next:null}let n=[],o=[],r=[],c=[],s=[],d=[];t.forEach((e=>{const t=e.date_start,a=parseFloat(e.spend)||0,l=parseFloat(e.reach)||0;let i=0,m=0,u=0;e.actions&&e.actions.forEach((e=>{"onsite_conversion.messaging_conversation_started_7d"===e.action_type&&(i=e.value||0),"post_reaction"===e.action_type&&(m=e.value||0),"like"===e.action_type&&(u=e.value||0)})),n.push(t),o.push(a),r.push(l),c.push(i),s.push(m),d.push(u)})),drawDailyChart(n,o,r,c,s,d),document.querySelector(".loading").classList.remove("active")}catch(e){document.querySelector(".loading").classList.remove("active")}}function drawDailyChart(e,t,a,n,o,r){const c=document.getElementById("dailyChart").getContext("2d");dailyChartInstance&&dailyChartInstance.destroy(),dailyChartInstance=new Chart(c,{type:"line",data:{labels:e,datasets:[{label:"Spend",data:t,borderColor:"#FFCE56",backgroundColor:"rgba(255, 206, 86, 0.2)",fill:!0,tension:.2},{label:"Reach",data:a,borderColor:"#FFCE56",backgroundColor:"rgba(255, 206, 86, 0.2)",fill:!0,tension:.2},{label:"Messaging Conversations",data:n,borderColor:"#FFCE56",backgroundColor:"rgba(255, 206, 86, 0.2)",fill:!0,tension:.2},{label:"Post Reactions",data:o,borderColor:"#FFCE56",backgroundColor:"rgba(255, 206, 86, 0.2)",fill:!0,tension:.2},{label:"Page Likes",data:r,borderColor:"#FFCE56",backgroundColor:"rgba(255, 206, 86, 0.2)",fill:!0,tension:.4}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{maxTicksLimit:8}}}}})}const downloadButtons=document.querySelectorAll(".download_btn");function downloadElementAsPNG(e,t){const a=document.getElementById(e);html2canvas(a).then((e=>{const a=document.createElement("a");a.href=e.toDataURL("image/png"),a.download=t,a.click()}))}downloadButtons.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-id");let a=e.getAttribute("data-name")||"screenshot.png";const n=localStorage.getItem("query");n&&(a=`${a} - ${n}`),downloadElementAsPNG(t,`${a}.png`)}))}));
